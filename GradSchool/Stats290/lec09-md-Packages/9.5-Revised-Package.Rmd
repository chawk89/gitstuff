---
title: "9.5. Revised R Package"
output:
     slidy_presentation
---

```{r, echo = FALSE}
## Install a package if not already installed
installIfNeeded <- function(packages, ...) {
    toInstall <- packages[!(packages %in% installed.packages()[, 1])]
    if (length(toInstall) > 0) {
        install.packages(toInstall, repos = "https://cloud.r-project.org")
    }
}

## Ensure packages exist and activate them
needPackages <- function(packages) {
    installIfNeeded(packages)
    for (x in packages) {
        library(x, character.only = TRUE)
    }
}
needPackages("devtools")
```

## 9.5.1. Revising our package

We are now going to make changes to our initial package to make it
conform to modern tools, particularly `devtools`. 


## 9.5.1. Package authors and documentation

The initial version of the package we created used a somewhat dated
way of describing package authors. The modern way is to use `person`
objects.  See `?person` for help on person field, roles etc. 


Next, documenting functions is probably the most tedious task, one
that should be done well so that the users of your package will find
the results useful. R's documentation uses `.Rd` files (Rdoc), which
are tedious to construct by hand. Furthermore, you will also provide
vignettes in addition to help to introduce your package capabilities
to the potential user. 

Wouldn't it be nice to use R markdown for documentation? Fear not: you
can. 

___

I directly edited the `DESCRIPTION` file as shown and the changed
version is under the `revised` folder.

```
Package: ted
Type: Package
Title: What the Package Does Using Title Case
Version: 1.0
Date: 2020-01-26
Authors@R: c(person(given = "Ted", family = "Cat",
                    email = "ted@somewhere.com",
		    role = c("aut", "cre")))
Description: More details about what the package does. See
        [Description File](http://cran.r-project.org/doc/manuals/r-release/R-exts.html#The-DESCRIPTION-file)
        for details on how to write this part.
License: GPL (>= 2)
Roxygen: list(markdown = TRUE)
Encoding: UTF-8
```

Pay attention to

- `Authors@R` field which is a list of `person` objects
- `Roxygen` field which you can use verbatim to avail yourself of R
  markdown syntax in documentation as we will soon see
- `Encoding` which should be `UTF-8` to avoid problems. 

`Roxygen` is a tool we will use for documentation as we will soon see.
___

## 9.5.2. NAMESPACE file

The previous `NAMESPACE` file was merely:

```{r, eval = FALSE}
exportPattern("^[[:alpha:]]+")
```

which meant export everything that begins with an alphabetic
character. 

To enable Roxygen to also take care of `NAMESPACE` we will trick it
into modifying it. We edit it as follows.

```
# Generated by roxygen2: do not edit by hand

exportPattern("^[[:alpha:]]+")
```

That is, we added two lines as shown at the beginning. Otherwise,
Roxygen will not touch it. 

## 9.5.3. The `man` directory

We will never want to deal with this ourselves; we'll let Roxygen
build it for us. Therefore, we delete this directory and everything in
it.

## 9.5.4. The R directory

We now edit the `.R` files to include the documentation. 

The file `hello.R`

```
#' A simple greeting function
#'
#' This function shows a standard text on the console. In a time-honoured
#' tradition, it defaults to displaying _hello, world_.
#'
#' @param txt the text to display, default `"world"`
#'
#' @examples
#'   hello()
#'   hello("and goodbye")
#' @export hello
hello <- function(txt = "world") {
    cat("Hello, ", txt, "\n")
}
```

Note the format where the Roxygen comments start with `#'`. Note also
how the parameters to the function are documented, and examples
provided. 

Finally, the function is _exported_, that is, it is made visible to
the user of the package. 

It is a good idea to _expose only those functions_ you want your users
to see. The others can remain unexported. 

Similarly the file `ted-package.R`. 

## 9.5.5. Building the package

Here we can use the `devtools` package to help us.

In Rstudio, you can choose _New Project_ and navigate to the (revised)
`ted` directory and create the project.

Then the following commands:

library(devtools)
```{r, eval = FALSE}
##setwd("~/library/R/3.6/library/devtools")
devtools::document("~/Downloads/newpackage")
devtools::build("~/Downloads/newpackage")
devtools::create("~/Downloads/newpackage")
getwd()

library(newpackage)
?newpackage
```

will build the `ted_1.0.tar.gz` source package file.

Notice what the above commands do, especially to the directory
structure and the files.

Among other things, the following happens:

- The `NAMESPACE` file is updated: only your exported functions are
  included there
- The documentation is generated in the `man` directory from the `.R`
  files













You can now check the generated package on the command line

```{bash, eval = FALSE}
bheeshma:tmp naras$ R CMD check moo_1.0.tar.gz 
* using log directory ‘/Users/naras/courses/2020/lectures/lec09/lec09-md/revised/tmp/ted.Rcheck’
* using R version 3.6.2 (2019-12-12)
* using platform: x86_64-apple-darwin19.2.0 (64-bit)
* using session charset: UTF-8
* checking for file ‘ted/DESCRIPTION’ ... OK
* checking extension type ... Package
* this is package ‘ted’ version ‘1.0’
* package encoding: UTF-8
* checking package namespace information ... OK
* checking package dependencies ... OK
* checking if this is a source package ... OK
* checking if there is a namespace ... OK
* checking for executable files ... OK
* checking for hidden files and directories ... OK
* checking for portable file names ... OK
* checking for sufficient/correct file permissions ... OK
* checking whether package ‘ted’ can be installed ... OK
* checking installed package size ... OK
* checking package directory ... OK
* checking DESCRIPTION meta-information ... OK
* checking top-level files ... OK
* checking for left-over files ... OK
* checking index information ... OK
* checking package subdirectories ... OK
* checking R files for non-ASCII characters ... OK
* checking R files for syntax errors ... OK
* checking whether the package can be loaded ... OK
* checking whether the package can be loaded with stated dependencies ... OK
* checking whether the package can be unloaded cleanly ... OK
* checking whether the namespace can be loaded with stated dependencies ... OK
* checking whether the namespace can be unloaded cleanly ... OK
* checking loading without being on the library search path ... OK
* checking dependencies in R code ... OK
* checking S3 generic/method consistency ... OK
* checking replacement functions ... OK
* checking foreign function calls ... OK
* checking R code for possible problems ... OK
* checking Rd files ... OK
* checking Rd metadata ... OK
* checking Rd cross-references ... OK
* checking for missing documentation entries ... OK
* checking for code/documentation mismatches ... OK
* checking Rd \usage sections ... OK
* checking Rd contents ... OK
* checking for unstated dependencies in examples ... OK
* checking examples ... OK
* checking PDF version of manual ... OK
* DONE

Status: OK

```

## Session Info
```{r}
sessionInfo()
```
